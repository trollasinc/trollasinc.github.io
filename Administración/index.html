<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de administración - Trollas Inc.</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet" />
    <style>
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background: #f4f6f8;
        margin: 0;
        padding: 0;
        color: #111;
      }
      header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        padding: 1rem;
        text-align: center;
        font-weight: 700;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      main {
        max-width: 1200px;
        margin: 2rem auto;
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      input,
      button,
      textarea {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      button {
        background: #007bff;
        color: white;
        cursor: pointer;
        border: none;
        transition: 0.3s;
      }
      button:hover {
        background: #0056b3;
      }
      .hidden {
        display: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        table-layout: fixed;
        word-wrap: break-word;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
      }
      th {
        background: #f0f0f0;
      }
      .section {
        margin-top: 2rem;
        border-top: 1px solid #ccc;
        padding-top: 1rem;
      }
      .table-container {
        overflow-x: auto;
      }
      .imgPreview {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }
      .navbar-admin {
        text-align: center;
        margin: 1rem 0;
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
      }
      .navbar-admin a {
        color: black;
        text-decoration: none;
        font-weight: 500;
      }
      @media (max-width: 768px) {
        main {
          margin: 1rem;
          padding: 1rem;
        }
        th,
        td {
          font-size: 14px;
          padding: 6px;
        }
        button,
        input,
        textarea {
          font-size: 14px;
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <header>Panel de administración - Trollas. Inc.</header>
    <main>
      <!-- Login -->
      <div id="loginForm">
        <h2>Iniciar sesión</h2>
        <input id="email" type="email" placeholder="Correo" />
        <input id="password" type="password" placeholder="Contraseña" />
        <button id="loginBtn">Entrar</button>
        <p id="loginMsg"></p>
      </div>

      <!-- Panel -->
      <div id="panel" class="hidden">
        <button id="logoutBtn" style="background: crimson">
          Cerrar sesión
        </button>
        <div class="navbar-admin">
          <a href="#visitantes">Visitantes</a>
          <a href="#clientes">Clientes</a>
          <a href="#blog">Blog</a>
          <a href="#detalle-de-visitas">Detalle de visitas</a>
          <a href="#correos">Correos</a>
        </div>

        <!-- Visitantes -->
        <div id="visitantes" class="section">
          <h3>📊 Visitantes</h3>
          <p id="contadorVisitantes">Cargando...</p>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="section">
          <h3>👥 Clientes</h3>
          <h4>Agregar / Editar Cliente</h4>
          <input type="text" id="nombre" placeholder="Nombre" />
          <input type="text" id="apellidos" placeholder="Apellidos" />
          <input type="email" id="correo" placeholder="Correo" />
          <input type="tel" id="telefono" placeholder="Teléfono" />
          <input type="text" id="plan" placeholder="Plan" />
          <textarea
            id="info"
            rows="3"
            placeholder="Información adicional"></textarea>
          <input type="file" id="fotoUpload" accept="image/*" />
          <button id="addClientBtn">Guardar Cliente</button>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Foto</th>
                  <th>Nombre</th>
                  <th>Apellidos</th>
                  <th>Correo</th>
                  <th>Teléfono</th>
                  <th>Plan</th>
                  <th>Info</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyClientes">
                <tr>
                  <td colspan="8" style="text-align: center">
                    Cargando clientes...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Blog -->
        <div id="blog" class="section">
          <h3>📰 Subir entrada al blog</h3>
          <input id="blogTitulo" type="text" placeholder="Título" />
          <textarea
            id="blogContenido"
            rows="5"
            placeholder="Contenido (HTML permitido)"></textarea>
          <input id="blogEnlace" type="text" placeholder="Enlace opcional" />
          <button id="addBlogBtn">Publicar entrada</button>
          <p id="blogMsg"></p>
        </div>

        <!-- Detalle de visitas -->
        <div id="detalle-de-visitas" class="section">
          <h3>📈 Detalle de visitas</h3>
          <input type="text" id="buscarIP" placeholder="Buscar por IP..." />
          <button id="btnBuscarIP">Buscar</button>
          <button id="refreshVisitasBtn">🔄 Refrescar</button>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Fecha y hora</th>
                  <th>Navegador</th>
                  <th>SO</th>
                  <th>Idioma</th>
                  <th>IP</th>
                  <th>Ciudad</th>
                  <th>Página</th>
                </tr>
              </thead>
              <tbody id="tbodyVisitas">
                <tr>
                  <td colspan="7" style="text-align: center">
                    Cargando visitas...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Correos -->
        <div id="correos" class="section">
          <h3>📧 Correos registrados</h3>
          <input
            type="text"
            id="buscarCorreo"
            placeholder="Buscar por correo..." />
          <button id="btnBuscarCorreo">Buscar</button>
          <button id="btnRefreshCorreos">🔄 Refrescar</button>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Correo</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tbodyCorreos">
                <tr>
                  <td colspan="2" style="text-align: center">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        addDoc,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

      // --- Configuración Firebase ---
      const firebaseConfig = {
        apiKey: "AIzaSyCx8ITT_KZVSzZTWN20qV1yEZ5CwILkm2M",
        authDomain: "trollas-inc-administracion.firebaseapp.com",
        projectId: "trollas-inc-administracion",
        storageBucket: "trollas-inc-administracion.firebasestorage.app",
        messagingSenderId: "247309275509",
        appId: "1:247309275509:web:33d62925b18474b2ac833c",
        measurementId: "G-G2T4HD22YH",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --- Elementos ---
      const loginForm = document.getElementById("loginForm");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const panel = document.getElementById("panel");
      const loginMsg = document.getElementById("loginMsg");

      const nombre = document.getElementById("nombre");
      const apellidos = document.getElementById("apellidos");
      const correo = document.getElementById("correo");
      const telefono = document.getElementById("telefono");
      const plan = document.getElementById("plan");
      const info = document.getElementById("info");
      const fotoUpload = document.getElementById("fotoUpload");
      const addClientBtn = document.getElementById("addClientBtn");
      const tbodyClientes = document.getElementById("tbodyClientes");
      const contadorVisitantes = document.getElementById("contadorVisitantes");

      let clientes = [];
      let editando = false;
      let clienteEditandoId = null;
      let imagenCliente = null;

      // --- Login ---
      loginBtn.addEventListener("click", async () => {
        try {
          await signInWithEmailAndPassword(
            auth,
            document.getElementById("email").value,
            document.getElementById("password").value
          );
        } catch (err) {
          loginMsg.textContent = err.message;
        }
      });

      logoutBtn.addEventListener("click", () => signOut(auth));

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          loginForm.style.display = "none";
          panel.classList.remove("hidden");
          await cargarClientes();
          await cargarVisitantes();
          await cargarVisitasDetalle();
          await cargarCorreos();
        } else {
          loginForm.style.display = "block";
          panel.classList.add("hidden");
        }
      });

      // --- Clientes ---
      async function cargarClientes() {
        try {
          const snap = await getDocs(collection(db, "clientes"));
          clientes = snap.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));
          mostrarClientes();
        } catch (err) {
          console.error(err);
          tbodyClientes.innerHTML =
            "<tr><td colspan='8' style='text-align:center;color:red'>Error cargando clientes</td></tr>";
        }
      }

      function mostrarClientes() {
        if (clientes.length === 0) {
          tbodyClientes.innerHTML =
            "<tr><td colspan='8' style='text-align:center'>No hay clientes</td></tr>";
          return;
        }
        tbodyClientes.innerHTML = "";
        clientes.forEach((c) => {
          tbodyClientes.innerHTML += `<tr>
      <td>${c.foto ? `<img src="${c.foto}" class="imgPreview">` : "-"}</td>
      <td>${c.nombre || ""}</td>
      <td>${c.apellidos || ""}</td>
      <td>${c.correo || ""}</td>
      <td>${c.telefono || ""}</td>
      <td>${c.plan || ""}</td>
      <td>${c.info || ""}</td>
      <td>
        <button onclick="editarCliente('${c.id}')">Editar</button>
        <button onclick="eliminarCliente('${c.id}')">Eliminar</button>
      </td>
    </tr>`;
        });
      }

      window.editarCliente = function (id) {
        const c = clientes.find((cl) => cl.id === id);
        if (!c) return;
        nombre.value = c.nombre;
        apellidos.value = c.apellidos;
        correo.value = c.correo;
        telefono.value = c.telefono;
        plan.value = c.plan;
        info.value = c.info;
        imagenCliente = c.foto;
        editando = true;
        clienteEditandoId = id;
        addClientBtn.textContent = "Actualizar Cliente";
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      window.eliminarCliente = async function (id) {
        if (confirm("Eliminar este cliente?")) {
          await deleteDoc(doc(db, "clientes", id));
          cargarClientes();
        }
      };

      addClientBtn.addEventListener("click", async () => {
        if (!nombre.value || !apellidos.value || !correo.value)
          return alert("Nombre, Apellidos y Correo obligatorios");
        const cliente = {
          nombre: nombre.value,
          apellidos: apellidos.value,
          correo: correo.value,
          telefono: telefono.value,
          plan: plan.value,
          info: info.value,
          foto: imagenCliente || "",
        };
        if (editando) {
          const docRef = doc(db, "clientes", clienteEditandoId);
          await updateDoc(docRef, cliente);
          editando = false;
          clienteEditandoId = null;
          addClientBtn.textContent = "Guardar Cliente";
        } else {
          await addDoc(collection(db, "clientes"), cliente);
        }
        limpiarFormulario();
        cargarClientes();
      });

      function limpiarFormulario() {
        nombre.value = "";
        apellidos.value = "";
        correo.value = "";
        telefono.value = "";
        plan.value = "";
        info.value = "";
        fotoUpload.value = "";
        imagenCliente = null;
      }

      fotoUpload.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => (imagenCliente = ev.target.result);
          reader.readAsDataURL(file);
        }
      });

      // --- Visitantes ---
      async function cargarVisitantes() {
        try {
          // Obtenemos el documento "visitas" de la colección "estadisticas"
          const visitasSnap = await getDoc(doc(db, "estadisticas", "visitas"));
          const contador = visitasSnap.exists()
            ? visitasSnap.data().contador
            : 0;
          contadorVisitantes.textContent = "Total visitantes: " + contador;
        } catch (err) {
          contadorVisitantes.textContent = "Error cargando visitantes";
          console.error(err);
        }
      }

      // --- Detalle visitas ---
      const tbodyVisitas = document.getElementById("tbodyVisitas");
      async function cargarVisitasDetalle(filtroIP = "") {
        const tbodyVisitas = document.getElementById("tbodyVisitas");
        tbodyVisitas.innerHTML =
          "<tr><td colspan='7' style='text-align:center'>Cargando...</td></tr>";

        try {
          const q = query(
            collection(db, "visitas_detalle"),
            orderBy("timestamp", "desc"),
            limit(50)
          );
          const snap = await getDocs(q);

          if (snap.empty) {
            tbodyVisitas.innerHTML =
              "<tr><td colspan='7' style='text-align:center'>No hay visitas registradas</td></tr>";
            return;
          }

          tbodyVisitas.innerHTML = "";
          snap.forEach((docSnap) => {
            const d = docSnap.data();
            const ip = d.ip || "—";

            // Filtrar por IP si se proporcionó
            if (filtroIP && !ip.includes(filtroIP)) return;

            const fecha = d.timestamp
              ? new Date(d.timestamp).toLocaleString()
              : "—";
            const navegador = d.navegador || "—";
            const so = d.so || "—";
            const idioma = d.idioma || "—";
            const ciudad = d.ciudad || "—";
            const pagina = d.page || "/";

            tbodyVisitas.innerHTML += `<tr>
        <td>${fecha}</td>
        <td>${navegador}</td>
        <td>${so}</td>
        <td>${idioma}</td>
        <td>${ip}</td>
        <td>${ciudad}</td>
        <td>${pagina}</td>
      </tr>`;
          });
        } catch (err) {
          console.error(err);
          tbodyVisitas.innerHTML =
            "<tr><td colspan='7' style='text-align:center'>Error cargando visitas</td></tr>";
        }
      }
      document.getElementById("btnBuscarIP").addEventListener("click", () => {
        const ip = document.getElementById("buscarIP").value.trim();
        cargarVisitasDetalle(ip); // filtra por la IP ingresada
      });

      document
        .getElementById("refreshVisitasBtn")
        .addEventListener("click", () => cargarVisitasDetalle());

      // --- Correos ---
      async function cargarCorreos(filtroCorreo = "") {
        const tableBody = document.getElementById("tbodyCorreos"); // Asegúrate de tener <tbody id="tbodyCorreos">
        tableBody.innerHTML =
          "<tr><td colspan='2' style='text-align:center'>Cargando...</td></tr>";

        try {
          const q = query(
            collection(db, "correos"),
            orderBy("fecha", "desc"),
            limit(100) // ajusta según necesites
          );
          const snap = await getDocs(q);

          if (snap.empty) {
            tableBody.innerHTML =
              "<tr><td colspan='2' style='text-align:center'>No hay correos registrados</td></tr>";
            return;
          }

          tableBody.innerHTML = "";
          snap.forEach((docSnap) => {
            const data = docSnap.data();
            const correo = data.correo || "";

            // Filtrar por correo si se proporciona
            if (filtroCorreo && !correo.includes(filtroCorreo)) return;

            const fecha = data.fecha?.toDate
              ? data.fecha.toDate().toLocaleString()
              : "—";

            tableBody.innerHTML += `<tr>
        <td>${correo}</td>
        <td>${fecha}</td>
      </tr>`;
          });
        } catch (err) {
          console.error(err);
          tableBody.innerHTML =
            "<tr><td colspan='2' style='text-align:center'>Error cargando correos</td></tr>";
        }
      }

      // Buscar correo
      document
        .getElementById("btnBuscarCorreo")
        .addEventListener("click", () => {
          const filtro = document.getElementById("buscarCorreo").value.trim();
          cargarCorreos(filtro);
        });

      // Refrescar todos
      document
        .getElementById("btnRefreshCorreos")
        .addEventListener("click", () => {
          cargarCorreos(); // sin filtro
        });
    </script>
  </body>
</html>
