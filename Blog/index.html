<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog - Trollas. Inc.</title>
    <link rel="icon" href="../Logos/Trollas. Inc.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background: #f0f4f8;
        color: #111;
      }
      header {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.5);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      header h1 {
        font-weight: 700;
      }
      nav a {
        margin-left: 1.5rem;
        text-decoration: none;
        color: #111;
        font-weight: 500;
      }
      main {
        max-width: 900px;
        margin: 3rem auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .post {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 2rem;
        transition: transform 0.3s;
      }
      .post:hover {
        transform: translateY(-5px);
      }
      .post h2 {
        margin-bottom: 0.5rem;
      }
      .post p {
        color: #333;
        line-height: 1.6;
      }
      .date {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 1rem;
      }
      footer {
        text-align: center;
        padding: 2rem;
        font-size: 0.9rem;
        color: #555;
      }
    </style>
    <style>
      /* Estilos básicos del popup */
      #emailModal {
        display: none; /* Oculto por defecto */
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      #emailModalContent {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        width: 300px;
        border-radius: 10px;
        text-align: center;
      }
      #emailModal input[type="email"] {
        width: 90%;
        padding: 10px;
        margin-bottom: 10px;
      }
      #emailModal button {
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <div id="emailModal">
      <div id="emailModalContent">
        <h2>Introduce tu correo para continuar</h2>
        <br />
        <p>
          Para acceder a ciertas funciones en la web como descargar videojuegos,
          juegos online o leer las noticias del blog deberás iniciar sesión con
          tu correo electrónico
        </p>
        <br />
        <input
          type="email"
          id="userEmail"
          placeholder="correo@ejemplo.com"
          required />
        <br />
        <button id="submitEmail">Enviar</button>
      </div>
    </div>
    <header>
      <h1>Trollas. Inc.</h1>
      <nav>
        <a href="../index.html">⬅️ Volver ⬅️</a>
      </nav>
    </header>

    <main></main>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        increment,
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // Config Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCx8ITT_KZVSzZTWN20qV1yEZ5CwILkm2M",
        authDomain: "trollas-inc-administracion.firebaseapp.com",
        projectId: "trollas-inc-administracion",
        storageBucket: "trollas-inc-administracion.firebasestorage.app",
        messagingSenderId: "247309275509",
        appId: "1:247309275509:web:33d62925b18474b2ac833c",
        measurementId: "G-G2T4HD22YH",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Contar visita solo una vez por dispositivo
      async function contarVisitaUnaVez() {
        const yaVisito = localStorage.getItem("yaVisito");
        if (yaVisito) return;

        const visitasRef = doc(db, "estadisticas", "visitas");
        const visitasSnap = await getDoc(visitasRef);

        if (!visitasSnap.exists()) {
          await setDoc(visitasRef, { contador: 1 });
        } else {
          await updateDoc(visitasRef, { contador: increment(1) });
        }

        localStorage.setItem("yaVisito", "true");
      }

      // Info del dispositivo
      function obtenerInfoDispositivo() {
        const ua = navigator.userAgent || "";
        let so = "Desconocido";
        if (/Android/i.test(ua)) so = "Android";
        else if (/iPhone|iPad|iPod/i.test(ua)) so = "iOS";
        else if (/Windows/i.test(ua)) so = "Windows";
        else if (/Mac/i.test(ua)) so = "MacOS";
        else if (/Linux/i.test(ua)) so = "Linux";

        const dispositivo = /Android|iPhone|iPad|iPod/i.test(ua)
          ? "Móvil"
          : "PC";

        let navegador = "Desconocido";
        if (/Chrome/i.test(ua) && !/Edge|OPR/i.test(ua)) navegador = "Chrome";
        else if (/Firefox/i.test(ua)) navegador = "Firefox";
        else if (/Safari/i.test(ua) && !/Chrome/i.test(ua))
          navegador = "Safari";
        else if (/Edge/i.test(ua)) navegador = "Edge";
        else if (/OPR|Opera/i.test(ua)) navegador = "Opera";

        const resolucion = `${window.innerWidth}x${window.innerHeight}`;
        const idioma = navigator.language || navigator.userLanguage || "";

        return {
          visitanteID: obtenerVisitanteID(),
          timestamp: new Date().toISOString(),
          so,
          dispositivo,
          navegador,
          resolucion,
          idioma,
          referrer: document.referrer || "",
          page: location.pathname + location.search || "",
        };
      }

      // Generar ID único por visitante
      function obtenerVisitanteID() {
        let id = localStorage.getItem("visitanteID");
        if (!id) {
          id =
            crypto && crypto.randomUUID
              ? crypto.randomUUID()
              : "v-" +
                Date.now() +
                "-" +
                Math.random().toString(36).slice(2, 9);
          localStorage.setItem("visitanteID", id);
        }
        return id;
      }

      // Obtener IP
      async function obtenerIP() {
        try {
          const res = await fetch("https://ipapi.co/json/");
          const data = await res.json();
          return {
            ip: data.ip || "",
            ciudad: data.city || "",
            pais: data.country_name || "",
          };
        } catch (err) {
          console.error("No se pudo obtener IP:", err);
          return { ip: "", ciudad: "", pais: "" };
        }
      }

      // Registrar visita detallada
      async function registrarVisitaDetalle() {
        try {
          await contarVisitaUnaVez();
          const info = obtenerInfoDispositivo();
          const ipInfo = await obtenerIP();
          const infoCompleta = { ...info, ...ipInfo };
          await addDoc(collection(db, "visitas_detalle"), infoCompleta);
        } catch (err) {
          console.error("Error registrando visita detalle:", err);
        }
      }

      // Ejecutar
      registrarVisitaDetalle();

      // --- Popup y LocalStorage ---
      const modal = document.getElementById("emailModal");
      const submitBtn = document.getElementById("submitEmail");
      const emailInput = document.getElementById("userEmail");

      // Si no hay correo en localStorage, mostrar modal
      if (!localStorage.getItem("correoGuardado")) {
        modal.style.display = "block";
      }

      submitBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        if (email && /\S+@\S+\.\S+/.test(email)) {
          try {
            // Guardar en Firestore
            await addDoc(collection(db, "correos"), {
              correo: email,
              fecha: new Date(),
            });
            // Guardar en localStorage
            localStorage.setItem("correoGuardado", "true");
            // Ocultar modal
            modal.style.display = "none";
          } catch (error) {
            alert("Error al enviar el correo: " + error);
          }
        } else {
          alert("Por favor, introduce un correo válido.");
        }
      });

      // Opcional: evitar cerrar modal con clic fuera
      window.addEventListener("click", (e) => {
        if (e.target == modal) {
          e.preventDefault();
        }
      });
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCx8ITT_KZVSzZTWN20qV1yEZ5CwILkm2M",
        authDomain: "trollas-inc-administracion.firebaseapp.com",
        projectId: "trollas-inc-administracion",
        storageBucket: "trollas-inc-administracion.firebasestorage.app",
        messagingSenderId: "247309275509",
        appId: "1:247309275509:web:33d62925b18474b2ac833c",
        measurementId: "G-G2T4HD22YH",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const main = document.querySelector("main");

      async function cargarPosts() {
        try {
          const snapshot = await getDocs(collection(db, "blog"));
          const posts = snapshot.docs
            .map((doc) => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

          main.innerHTML = ""; // limpiar posts

          posts.forEach((post) => {
            const div = document.createElement("div");
            div.className = "post";
            div.innerHTML = `
        <h2>${post.titulo}</h2>
        <div class="date">${new Date(post.fecha).toLocaleDateString("es-ES", {
          day: "numeric",
          month: "long",
          year: "numeric",
        })}</div>
        <p>${post.contenido}</p>
        ${
          post.enlace ? `<a href="${post.enlace}" target="_blank">Aquí</a>` : ""
        }
      `;
            main.appendChild(div);
          });
        } catch (err) {
          console.error("Error cargando posts:", err);
          main.innerHTML = "<p style='color:red;'>Error cargando posts</p>";
        }
      }

      cargarPosts();
    </script>
    <footer>&copy; 2025 Trollas. Inc. Todos los derechos reservados.</footer>
  </body>
</html>
